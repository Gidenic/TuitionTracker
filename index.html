<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuition Centre Tracker</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyCIi6V8Q7zlKLd7BmjyylD87fLBaKkO65U",
            authDomain: "tuitiontracker-ac584.firebaseapp.com",
            projectId: "tuitiontracker-ac584",
            storageBucket: "tuitiontracker-ac584.firebasestorage.app",
            messagingSenderId: "121462363628",
            appId: "1:121462363628:web:7c9a1e8574dc2d74381cc9",
            databaseURL: "https://tuitiontracker-ac584-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        let database;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (error) {
            console.error("Firebase error:", error);
        }

        const PASSWORDS = { jancy: 'J404', arya: 'Y234', jabeena: 'J123' };

        const App = () => {
            const [user, setUser] = useState(null);
            const [faculty, setFaculty] = useState(null);
            const [pwd, setPwd] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [data, setData] = useState({});
            const [students, setStudents] = useState({ jancy: [], arya: [], jabeena: [] });
            const [schedules, setSchedules] = useState({});
            const [exams, setExams] = useState({});
            const [schoolTimetables, setSchoolTimetables] = useState({});
            const [loading, setLoading] = useState(true);
            const [editSchedule, setEditSchedule] = useState(null);
            const [editExam, setEditExam] = useState(null);
            const [editSchoolTimetable, setEditSchoolTimetable] = useState(null);
            const [showManagement, setShowManagement] = useState(false);
            const [showReport, setShowReport] = useState(false);
            const [showTimetables, setShowTimetables] = useState(false);
            const [editingStudent, setEditingStudent] = useState(null);
            const [newStudent, setNewStudent] = useState({ name: '', grade: '', time: '', subjects: '', faculty: 'jancy' });
            const [reportStart, setReportStart] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 7);
                return d.toISOString().split('T')[0];
            });
            const [reportEnd, setReportEnd] = useState(new Date().toISOString().split('T')[0]);
            const [sortBy, setSortBy] = useState('grade');
            const [sortOrder, setSortOrder] = useState('asc');

            useEffect(() => {
                if (!database) return;
                database.ref('students').on('value', s => { if(s.exists()) setStudents(s.val()); setLoading(false); });
                database.ref('weeklyData').on('value', s => { if(s.exists()) setData(s.val()); });
                database.ref('schedules').on('value', s => { if(s.exists()) setSchedules(s.val()); });
                database.ref('examSchedules').on('value', s => { if(s.exists()) setExams(s.val()); });
                database.ref('schoolTimetables').on('value', s => { if(s.exists()) setSchoolTimetables(s.val()); });
            }, []);

            const login = () => {
                if (pwd === PASSWORDS[faculty]) { setUser(faculty); setPwd(''); }
                else { alert('Wrong password!'); setPwd(''); }
            };

            const grade = (g) => {
                if (!g) return 0;
                if (g === 'LKG') return -2;
                if (g === 'UKG') return -1;
                return parseInt(g) || 0;
            };

            const studs = () => {
                if (!user) return [];
                let list = [...(students[user] || [])];
                
                if (user === 'jancy') {
                    const abacusStudents = list.filter(s => 
                        s.subjects.length === 1 && s.subjects[0] === 'ABACUS ONLY'
                    );
                    const regularStudents = list.filter(s => 
                        !(s.subjects.length === 1 && s.subjects[0] === 'ABACUS ONLY')
                    );
                    
                    if (sortBy === 'grade') {
                        regularStudents.sort((a, b) => {
                            const diff = grade(a.grade) - grade(b.grade);
                            return sortOrder === 'asc' ? diff : -diff;
                        });
                    } else if (sortBy === 'name') {
                        regularStudents.sort((a, b) => {
                            const nameA = (a.name || '').toUpperCase();
                            const nameB = (b.name || '').toUpperCase();
                            const diff = nameA.localeCompare(nameB);
                            return sortOrder === 'asc' ? diff : -diff;
                        });
                    }
                    
                    abacusStudents.sort((a, b) => grade(a.grade) - grade(b.grade));
                    return [...regularStudents, ...abacusStudents];
                } else {
                    if (sortBy === 'grade') {
                        list.sort((a, b) => {
                            const diff = grade(a.grade) - grade(b.grade);
                            return sortOrder === 'asc' ? diff : -diff;
                        });
                    } else if (sortBy === 'name') {
                        list.sort((a, b) => {
                            const nameA = (a.name || '').toUpperCase();
                            const nameB = (b.name || '').toUpperCase();
                            const diff = nameA.localeCompare(nameB);
                            return sortOrder === 'asc' ? diff : -diff;
                        });
                    }
                    return list;
                }
            };

            const toggleSort = (column) => {
                if (sortBy === column) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortBy(column);
                    setSortOrder('asc');
                }
            };

            const toggle = (sid, sub) => {
                const k = `${date}-${sid}-${sub}`;
                if(database) database.ref(`weeklyData/${k}`).set(!data[k]);
            };

            const toggleAllSubject = (subject) => {
                const list = studs();
                const updates = {};
                let hasUnchecked = false;
                
                list.forEach(st => {
                    if (st.subjects.includes(subject)) {
                        const k = `${date}-${st.id}-${subject}`;
                        if (!data[k]) hasUnchecked = true;
                    }
                });
                
                list.forEach(st => {
                    if (st.subjects.includes(subject)) {
                        const k = `${date}-${st.id}-${subject}`;
                        updates[k] = hasUnchecked;
                    }
                });
                
                if(database) database.ref('weeklyData').update(updates);
            };

            const checked = (sid, sub) => data[`${date}-${sid}-${sub}`] || false;

            const saveSchedule = () => {
                if(!editSchedule?.schedule) return alert('Set schedule');
                if(database) database.ref(`schedules/${editSchedule.id}`).set(editSchedule.schedule);
                setEditSchedule(null);
                alert('Saved!');
            };

            const saveExam = () => {
                if(!editExam?.exams) return alert('Set exam dates');
                if(database) database.ref(`examSchedules/${editExam.id}`).set(editExam.exams);
                setEditExam(null);
                alert('Exam schedule saved!');
            };

            const saveSchoolTimetable = () => {
                if(!editSchoolTimetable?.timetable) return alert('Enter timetable');
                if(database) database.ref(`schoolTimetables/${editSchoolTimetable.id}`).set(editSchoolTimetable.timetable);
                setEditSchoolTimetable(null);
                alert('School timetable saved!');
            };

            const isExamPeriod = (studentId, today) => {
                const examSchedule = exams[studentId];
                if (!examSchedule) return false;
                
                const todayDate = new Date(today);
                todayDate.setHours(0, 0, 0, 0);
                
                for (let subject in examSchedule) {
                    const examDate = new Date(examSchedule[subject]);
                    examDate.setHours(0, 0, 0, 0);
                    if (examDate.getTime() === todayDate.getTime()) {
                        return true;
                    }
                }
                return false;
            };

            const getTodayExamSubject = (studentId, today) => {
                const examSchedule = exams[studentId];
                if (!examSchedule) return null;
                
                const todayDate = new Date(today);
                todayDate.setHours(0, 0, 0, 0);
                
                for (let subject in examSchedule) {
                    const examDate = new Date(examSchedule[subject]);
                    examDate.setHours(0, 0, 0, 0);
                    if (examDate.getTime() === todayDate.getTime()) {
                        return subject;
                    }
                }
                return null;
            };

            const addStudent = () => {
                if (!newStudent.name || !newStudent.grade || !newStudent.subjects) {
                    return alert('Please fill all required fields!');
                }
                const student = {
                    id: Date.now(),
                    name: newStudent.name.toUpperCase(),
                    grade: newStudent.grade,
                    time: newStudent.time || '4-6',
                    subjects: newStudent.subjects.split(',').map(s => s.trim())
                };
                const updated = { ...students };
                updated[newStudent.faculty] = [...(updated[newStudent.faculty] || []), student];
                if(database) database.ref('students').set(updated);
                setNewStudent({ name: '', grade: '', time: '', subjects: '', faculty: 'jancy' });
                alert('Student added!');
            };

            const updateStudent = () => {
                if (!editingStudent.name || !editingStudent.grade) {
                    return alert('Please fill required fields!');
                }
                const updated = { ...students };
                Object.keys(updated).forEach(f => {
                    updated[f] = updated[f].filter(s => s.id !== editingStudent.id);
                });
                const student = {
                    ...editingStudent,
                    name: editingStudent.name.toUpperCase(),
                    subjects: typeof editingStudent.subjects === 'string' 
                        ? editingStudent.subjects.split(',').map(s => s.trim())
                        : editingStudent.subjects
                };
                updated[editingStudent.faculty] = [...(updated[editingStudent.faculty] || []), student];
                if(database) database.ref('students').set(updated);
                setEditingStudent(null);
                alert('Student updated!');
            };

            const removeStudent = (fac, sid) => {
                if (!confirm('Remove this student?')) return;
                const updated = { ...students };
                updated[fac] = updated[fac].filter(s => s.id !== sid);
                if(database) database.ref('students').set(updated);
            };

            const getDateRange = (start, end) => {
                const dates = [];
                const current = new Date(start);
                const endDate = new Date(end);
                while (current <= endDate) {
                    dates.push(new Date(current).toISOString().split('T')[0]);
                    current.setDate(current.getDate() + 1);
                }
                return dates;
            };

            const calculateWeeklyCoverage = (student) => {
                const dates = getDateRange(reportStart, reportEnd);
                const covered = new Set();
                dates.forEach(d => {
                    student.subjects.forEach(sub => {
                        if (data[`${d}-${student.id}-${sub}`]) {
                            covered.add(sub);
                        }
                    });
                });
                return {
                    covered: covered.size,
                    total: student.subjects.length,
                    percentage: Math.round((covered.size / student.subjects.length) * 100),
                    missing: student.subjects.filter(s => !covered.has(s))
                };
            };

            const colors = { jancy: 'blue', arya: 'green', jabeena: 'gray' };
            const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

            if(loading) return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="animate-spin h-16 w-16 border-4 border-purple-600 border-t-transparent rounded-full"></div>
                </div>
            );

            if(!faculty) return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h1 className="text-3xl font-bold text-center mb-8">Tuition Tracker</h1>
                        <div className="space-y-4">
                            <button onClick={() => setFaculty('jancy')} className="w-full bg-blue-500 text-white font-bold py-4 rounded-lg hover:bg-blue-600">Jancy (Head Faculty)</button>
                            <button onClick={() => setFaculty('arya')} className="w-full bg-green-500 text-white font-bold py-4 rounded-lg hover:bg-green-600">Arya</button>
                            <button onClick={() => setFaculty('jabeena')} className="w-full bg-gray-600 text-white font-bold py-4 rounded-lg hover:bg-gray-700">Jabeena</button>
                        </div>
                    </div>
                </div>
            );

            if(!user) return (
                <div className="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <h2 className="text-2xl font-bold text-center mb-4 capitalize">{faculty}</h2>
                        <input type="password" value={pwd} onChange={e=>setPwd(e.target.value)} onKeyPress={e=>e.key==='Enter'&&login()} placeholder="Password" className="w-full px-4 py-3 border-2 rounded-lg mb-4 text-center" autoFocus />
                        <button onClick={login} className="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 mb-2">Login</button>
                        <button onClick={()=>setFaculty(null)} className="w-full bg-gray-300 text-gray-700 font-bold py-3 rounded-lg hover:bg-gray-400">Back</button>
                    </div>
                </div>
            );

            const list = studs();
            const subs = [...new Set(list.flatMap(s=>s.subjects))].sort();
            const c = colors[user];

            // SCHOOL TIMETABLE EDITOR - NEW FORMAT
            if(editSchoolTimetable) {
                const st = list.find(s=>s.id===editSchoolTimetable.id);
                
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-7xl mx-auto bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold mb-2">School Timetable: {st?.name}</h2>
                            <p className="text-sm text-gray-600 mb-4">Enter school timetable - Days in rows, subjects in columns (up to 8 periods). Use "BREAK" or "LUNCH" for breaks.</p>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm border-collapse">
                                    <thead>
                                        <tr className="bg-blue-100">
                                            <th className="border-2 border-gray-400 p-2 font-bold">Day</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 1</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 2</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 3</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 4</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 5</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 6</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 7</th>
                                            <th className="border-2 border-gray-400 p-2 font-bold">Period 8</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {days.map((day, dayIdx) => (
                                            <tr key={day}>
                                                <td className="border-2 border-gray-400 p-2 font-bold bg-gray-100">{day}</td>
                                                {[0,1,2,3,4,5,6,7].map(periodIdx => (
                                                    <td key={periodIdx} className="border-2 border-gray-400 p-1">
                                                        <input
                                                            type="text"
                                                            placeholder="Subject"
                                                            value={editSchoolTimetable.timetable?.[dayIdx]?.[periodIdx] || ''}
                                                            onChange={e => {
                                                                const tt = editSchoolTimetable.timetable || {};
                                                                if (!tt[dayIdx]) tt[dayIdx] = {};
                                                                tt[dayIdx][periodIdx] = e.target.value;
                                                                setEditSchoolTimetable({...editSchoolTimetable, timetable: tt});
                                                            }}
                                                            className="w-full px-2 py-1 border rounded text-center"
                                                        />
                                                    </td>
                                                ))}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="flex gap-3 mt-6">
                                <button onClick={saveSchoolTimetable} className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700">Save Timetable</button>
                                <button onClick={()=>setEditSchoolTimetable(null)} className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // EXAM SCHEDULE EDITOR - DATE BASED
            if(editExam) {
                const st = list.find(s=>s.id===editExam.id);
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold mb-4 text-red-700">Exam Schedule: {st?.name}</h2>
                            <p className="text-sm text-gray-600 mb-4">Set exam date for each subject. Exams can span 2-3 weeks.</p>
                            
                            <div className="grid md:grid-cols-2 gap-4">
                                {st?.subjects.map(sub => (
                                    <div key={sub} className="border-2 border-red-200 rounded-lg p-4 bg-red-50">
                                        <label className="block">
                                            <span className="font-bold text-red-900">{sub}</span>
                                            <input
                                                type="date"
                                                value={editExam.exams?.[sub] || ''}
                                                onChange={e => {
                                                    const exs = editExam.exams || {};
                                                    exs[sub] = e.target.value;
                                                    setEditExam({...editExam, exams: exs});
                                                }}
                                                className="w-full mt-2 px-3 py-2 border-2 border-red-300 rounded"
                                            />
                                        </label>
                                    </div>
                                ))}
                            </div>
                            
                            <div className="flex gap-3 mt-6">
                                <button onClick={saveExam} className="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700">Save Exam Dates</button>
                                <button onClick={()=>setEditExam(null)} className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            }

            // TIMETABLES VIEW
            if(showTimetables) {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div style={{backgroundColor: c === 'blue' ? '#2563eb' : c === 'green' ? '#16a34a' : '#4b5563'}} className="text-white p-4">
                            <div className="max-w-7xl mx-auto flex justify-between">
                                <h1 className="text-xl font-bold">School Timetables & Exams</h1>
                                <button onClick={() => setShowTimetables(false)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">Back</button>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto p-4">
                            {list.filter(s => !(s.subjects.length === 1 && s.subjects[0] === 'ABACUS ONLY')).map(st => {
                                const tt = schoolTimetables[st.id];
                                const examSch = exams[st.id];
                                
                                return (
                                    <div key={st.id} className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                        <div className="flex justify-between items-center mb-4">
                                            <div>
                                                <h3 className="text-xl font-bold">{st.name}</h3>
                                                <p className="text-sm text-gray-600">Grade {st.grade} ‚Ä¢ {st.time}</p>
                                            </div>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => setEditSchoolTimetable({id: st.id, timetable: tt || {}})}
                                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                                    {tt ? '‚úèÔ∏è Edit' : '‚ûï Add'} Timetable
                                                </button>
                                                <button 
                                                    onClick={() => setEditExam({id: st.id, exams: examSch || {}})}
                                                    className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                                    {examSch ? '‚úèÔ∏è Edit' : '‚ûï Add'} Exams
                                                </button>
                                            </div>
                                        </div>

                                        {/* School Timetable */}
                                        {tt && (
                                            <div className="mb-6">
                                                <h4 className="font-bold mb-2 text-blue-900">üìö School Timetable</h4>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-xs border-collapse">
                                                        <thead>
                                                            <tr className="bg-blue-100">
                                                                <th className="border-2 border-gray-400 p-2 font-bold">Day</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P1</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P2</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P3</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P4</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P5</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P6</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P7</th>
                                                                <th className="border-2 border-gray-400 p-2 font-bold">P8</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {days.map((day, dayIdx) => (
                                                                <tr key={day}>
                                                                    <td className="border-2 border-gray-400 p-2 font-bold bg-gray-100">{day}</td>
                                                                    {[0,1,2,3,4,5,6,7].map(periodIdx => {
                                                                        const subject = tt[dayIdx]?.[periodIdx] || '';
                                                                        const isBreak = subject.toUpperCase().includes('BREAK') || subject.toUpperCase().includes('LUNCH');
                                                                        return (
                                                                            <td 
                                                                                key={periodIdx} 
                                                                                className="border-2 border-gray-400 p-2 text-center font-semibold"
                                                                                style={{
                                                                                    backgroundColor: isBreak ? '#fef3c7' : subject ? '#dcfce7' : '#fff',
                                                                                    color: isBreak ? '#92400e' : '#000'
                                                                                }}>
                                                                                {subject || '-'}
                                                                            </td>
                                                                        );
                                                                    })}
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}

                                        {/* Exam Schedule */}
                                        {examSch && Object.keys(examSch).length > 0 && (
                                            <div>
                                                <h4 className="font-bold mb-2 text-red-900">üìù Exam Schedule</h4>
                                                <div className="grid md:grid-cols-3 gap-2">
                                                    {Object.keys(examSch).sort((a,b) => new Date(examSch[a]) - new Date(examSch[b])).map(subject => (
                                                        <div key={subject} className="bg-red-50 border-2 border-red-300 rounded p-3">
                                                            <div className="font-bold text-red-900">{subject}</div>
                                                            <div className="text-sm">{new Date(examSch[subject]).toLocaleDateString('en-GB')}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {!tt && !examSch && (
                                            <div className="text-center py-8 text-gray-500 border-2 border-dashed rounded">
                                                <p>No timetables or exams set</p>
                                                <p className="text-sm">Click buttons above to add</p>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            }

            // Continue with other views (Management, Report, etc.) in next part...
            
            if(showManagement && user === 'jancy') {
                return (
                    <div className="min-h-screen bg-gray-50">
                        <div style={{backgroundColor: '#2563eb'}} className="text-white p-4">
                            <div className="max-w-7xl mx-auto flex justify-between">
                                <h1 className="text-xl font-bold">Student Management</h1>
                                <button onClick={() => setShowManagement(false)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">Back</button>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto p-4">
                            <div className="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 className="text-xl font-bold mb-4">{editingStudent ? 'Edit Student' : 'Add Student'}</h2>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <input type="text" placeholder="Name" value={editingStudent ? editingStudent.name : newStudent.name}
                                        onChange={e => editingStudent ? setEditingStudent({...editingStudent, name: e.target.value}) : setNewStudent({...newStudent, name: e.target.value})}
                                        className="border rounded px-4 py-2" />
                                    <input type="text" placeholder="Grade" value={editingStudent ? editingStudent.grade : newStudent.grade}
                                        onChange={e => editingStudent ? setEditingStudent({...editingStudent, grade: e.target.value}) : setNewStudent({...newStudent, grade: e.target.value})}
                                        className="border rounded px-4 py-2" />
                                    <input type="text" placeholder="Time" value={editingStudent ? editingStudent.time : newStudent.time}
                                        onChange={e => editingStudent ? setEditingStudent({...editingStudent, time: e.target.value}) : setNewStudent({...newStudent, time: e.target.value})}
                                        className="border rounded px-4 py-2" />
                                    <input type="text" placeholder="Subjects (comma separated)" 
                                        value={editingStudent ? (Array.isArray(editingStudent.subjects) ? editingStudent.subjects.join(', ') : editingStudent.subjects) : newStudent.subjects}
                                        onChange={e => editingStudent ? setEditingStudent({...editingStudent, subjects: e.target.value}) : setNewStudent({...newStudent, subjects: e.target.value})}
                                        className="border rounded px-4 py-2" />
                                    <select value={editingStudent ? editingStudent.faculty : newStudent.faculty}
                                        onChange={e => editingStudent ? setEditingStudent({...editingStudent, faculty: e.target.value}) : setNewStudent({...newStudent, faculty: e.target.value})}
                                        className="border rounded px-4 py-2">
                                        <option value="jancy">Jancy</option>
                                        <option value="arya">Arya</option>
                                        <option value="jabeena">Jabeena</option>
                                    </select>
                                    {editingStudent ? (
                                        <div className="flex gap-2">
                                            <button onClick={updateStudent} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update</button>
                                            <button onClick={() => setEditingStudent(null)} className="flex-1 bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
                                        </div>
                                    ) : (
                                        <button onClick={addStudent} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Student</button>
                                    )}
                                </div>
                            </div>

                            {Object.keys(students).map(fac => (
                                <div key={fac} className="bg-white rounded-lg shadow p-6 mb-4">
                                    <h3 className="text-lg font-bold mb-4 capitalize">{fac} ({students[fac].length} students)</h3>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="p-2 border">Name</th>
                                                    <th className="p-2 border">Grade</th>
                                                    <th className="p-2 border">Time</th>
                                                    <th className="p-2 border">Subjects</th>
                                                    <th className="p-2 border">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {students[fac].map(st => (
                                                    <tr key={st.id} className="hover:bg-gray-50">
                                                        <td className="p-2 border">{st.name}</td>
                                                        <td className="p-2 border text-center">{st.grade}</td>
                                                        <td className="p-2 border text-center">{st.time}</td>
                                                        <td className="p-2 border text-xs">{st.subjects.join(', ')}</td>
                                                        <td className="p-2 border text-center">
                                                            <button onClick={() => setEditingStudent({...st, faculty: fac})} className="text-blue-600 hover:text-blue-800 mx-1">‚úèÔ∏è</button>
                                                            <button onClick={() => removeStudent(fac, st.id)} className="text-red-600 hover:text-red-800 mx-1">üóëÔ∏è</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            if(showReport) {
                const reportStudents = user === 'jancy' 
                    ? [
                        ...students.jancy.map(s => ({ ...s, faculty: 'Jancy' })),
                        ...students.arya.map(s => ({ ...s, faculty: 'Arya' })),
                        ...students.jabeena.map(s => ({ ...s, faculty: 'Jabeena' }))
                    ]
                    : students[user].map(s => ({ ...s, faculty: user }));

                return (
                    <div className="min-h-screen bg-gray-50">
                        <div style={{backgroundColor: c === 'blue' ? '#2563eb' : c === 'green' ? '#16a34a' : '#4b5563'}} className="text-white p-4">
                            <div className="max-w-7xl mx-auto flex justify-between">
                                <h1 className="text-xl font-bold">Weekly Coverage Report</h1>
                                <button onClick={() => setShowReport(false)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">Back</button>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto p-4">
                            <div className="bg-white rounded-lg shadow p-4 mb-4">
                                <h3 className="font-bold mb-3">Report Period</h3>
                                <div className="flex gap-4 flex-wrap">
                                    <div>
                                        <label className="block text-sm mb-1">Start Date</label>
                                        <input type="date" value={reportStart} onChange={e => setReportStart(e.target.value)} className="border rounded px-4 py-2" />
                                    </div>
                                    <div>
                                        <label className="block text-sm mb-1">End Date</label>
                                        <input type="date" value={reportEnd} onChange={e => setReportEnd(e.target.value)} className="border rounded px-4 py-2" />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow p-6 overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead>
                                        <tr className="bg-gray-100">
                                            {user === 'jancy' && <th className="p-2 border">Faculty</th>}
                                            <th className="p-2 border">Student</th>
                                            <th className="p-2 border">Grade</th>
                                            <th className="p-2 border">Total</th>
                                            <th className="p-2 border">Covered</th>
                                            <th className="p-2 border">Coverage %</th>
                                            <th className="p-2 border">Missing</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {reportStudents.map(st => {
                                            const coverage = calculateWeeklyCoverage(st);
                                            return (
                                                <tr key={`${st.faculty}-${st.id}`} className="hover:bg-gray-50">
                                                    {user === 'jancy' && (
                                                        <td className="p-2 border">
                                                            <span style={{
                                                                backgroundColor: st.faculty === 'Jancy' ? '#dbeafe' : st.faculty === 'Arya' ? '#dcfce7' : '#f3f4f6',
                                                                color: st.faculty === 'Jancy' ? '#1e40af' : st.faculty === 'Arya' ? '#166534' : '#374151'
                                                            }} className="px-2 py-1 rounded text-xs">
                                                                {st.faculty}
                                                            </span>
                                                        </td>
                                                    )}
                                                    <td className="p-2 border font-semibold">{st.name}</td>
                                                    <td className="p-2 border text-center">{st.grade}</td>
                                                    <td className="p-2 border text-center">{coverage.total}</td>
                                                    <td className="p-2 border text-center">{coverage.covered}</td>
                                                    <td className="p-2 border text-center">
                                                        <span style={{
                                                            backgroundColor: coverage.percentage === 100 ? '#dcfce7' : coverage.percentage >= 70 ? '#fef9c3' : coverage.percentage >= 50 ? '#fed7aa' : '#fee2e2',
                                                            color: coverage.percentage === 100 ? '#166534' : coverage.percentage >= 70 ? '#854d0e' : coverage.percentage >= 50 ? '#9a3412' : '#991b1b'
                                                        }} className="px-3 py-1 rounded-full font-bold">
                                                            {coverage.percentage}%
                                                        </span>
                                                    </td>
                                                    <td className="p-2 border text-xs">
                                                        {coverage.missing.length > 0 ? (
                                                            <span className="text-red-600">{coverage.missing.join(', ')}</span>
                                                        ) : (
                                                            <span className="text-green-600 font-bold">‚úì Complete</span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            }

            if(editSchedule) {
                const st = list.find(s=>s.id===editSchedule.id);
                return (
                    <div className="min-h-screen bg-gray-50 p-4">
                        <div className="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold mb-4">Edit Tuition Schedule: {st?.name}</h2>
                            <p className="text-sm text-gray-600 mb-4">Select which subjects to teach each day at tuition</p>
                            <div className="grid md:grid-cols-3 gap-4">
                                {days.map((day,i) => (
                                    <div key={day} className="border rounded-lg p-4">
                                        <h3 className="font-bold mb-2">{day}</h3>
                                        {st?.subjects.map(sub => (
                                            <label key={sub} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer">
                                                <input type="checkbox" checked={(editSchedule.schedule?.[i]||[]).includes(sub)} 
                                                    onChange={e=>{
                                                        const s = editSchedule.schedule || {};
                                                        const d = s[i] || [];
                                                        s[i] = e.target.checked ? [...d,sub] : d.filter(x=>x!==sub);
                                                        setEditSchedule({...editSchedule, schedule:s});
                                                    }} className="w-4 h-4" />
                                                <span className="text-sm">{sub}</span>
                                            </label>
                                        ))}
                                    </div>
                                ))}
                            </div>
                            <div className="flex gap-3 mt-6">
                                <button onClick={saveSchedule} className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">Save</button>
                                <button onClick={()=>setEditSchedule(null)} className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400">Cancel</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <div style={{backgroundColor: c === 'blue' ? '#2563eb' : c === 'green' ? '#16a34a' : '#4b5563'}} className="text-white p-4">
                        <div className="max-w-7xl mx-auto flex justify-between items-center flex-wrap gap-2">
                            <div>
                                <h1 className="text-xl font-bold capitalize">{user} Dashboard</h1>
                                <p className="text-sm opacity-90">{list.length} Students</p>
                            </div>
                            <div className="flex gap-2 flex-wrap">
                                <button onClick={() => setShowTimetables(true)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">üè´ Timetables</button>
                                <button onClick={() => setShowReport(true)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">üìä Report</button>
                                {user === 'jancy' && (
                                    <button onClick={() => setShowManagement(true)} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">‚öôÔ∏è Manage</button>
                                )}
                                <button onClick={()=>{setUser(null);setFaculty(null);}} className="bg-white bg-opacity-20 px-4 py-2 rounded hover:bg-opacity-30">Logout</button>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white border-b p-4">
                        <div className="max-w-7xl mx-auto flex gap-3 items-center flex-wrap">
                            <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="border rounded px-4 py-2" />
                            {list.some(st => isExamPeriod(st.id, date)) && (
                                <div className="ml-auto bg-red-100 border-2 border-red-400 px-4 py-2 rounded font-bold text-red-900">
                                    üéØ EXAM DAY
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="max-w-full mx-auto p-4">
                        <div className="bg-white rounded-lg shadow mb-6 overflow-x-auto">
                            <table className="w-full text-sm">
                                <thead>
                                    <tr style={{backgroundColor: c === 'blue' ? '#dbeafe' : c === 'green' ? '#dcfce7' : '#f3f4f6'}}>
                                        <th className="p-3 border cursor-pointer hover:bg-blue-200" onClick={() => toggleSort('name')}>
                                            Student {sortBy === 'name' && (sortOrder === 'asc' ? '‚ñ≤' : '‚ñº')}
                                        </th>
                                        <th className="p-3 border cursor-pointer hover:bg-blue-200" onClick={() => toggleSort('grade')}>
                                            Grade {sortBy === 'grade' && (sortOrder === 'asc' ? '‚ñ≤' : '‚ñº')}
                                        </th>
                                        <th className="p-3 border">Actions</th>
                                        {subs.map(s => (
                                            <th key={s} className="p-3 border cursor-pointer hover:bg-yellow-100" 
                                                onClick={() => toggleAllSubject(s)}
                                                title="Click to toggle all students">
                                                {s}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {list.map(st => {
                                        const examSubject = getTodayExamSubject(st.id, date);
                                        const isExamDay = examSubject !== null;
                                        
                                        return (
                                            <tr key={st.id} className={`hover:bg-gray-50 ${isExamDay ? 'bg-red-50' : ''}`}>
                                                <td className="p-3 border font-bold">
                                                    {st.name}
                                                    {isExamDay && <span className="ml-2 text-red-600 text-xs">üéØ EXAM: {examSubject}</span>}
                                                </td>
                                                <td className="p-3 border text-center">{st.grade}</td>
                                                <td className="p-3 border text-center">
                                                    <button onClick={()=>setEditSchedule({id:st.id,schedule:schedules[st.id]||{}})} className="text-blue-600 hover:text-blue-800 mx-1" title="Edit Tuition Schedule">‚úèÔ∏è</button>
                                                    <button onClick={()=>setEditExam({id:st.id,exams:exams[st.id]||{}})} className="text-red-600 hover:text-red-800 mx-1" title="Edit Exam Dates">üìö</button>
                                                </td>
                                                {subs.map(sub => {
                                                    const has = st.subjects.includes(sub);
                                                    const chk = checked(st.id, sub);
                                                    const isExamSubToday = sub === examSubject;
                                                    
                                                    return has ? (
                                                        <td 
                                                            key={sub} 
                                                            className={`p-3 border cursor-pointer text-center ${
                                                                chk ? 'bg-green-100' : 
                                                                isExamSubToday ? 'bg-red-200 border-red-500 border-2' :
                                                                'hover:bg-blue-50'
                                                            }`} 
                                                            onClick={()=>toggle(st.id,sub)}>
                                                            {chk ? '‚úÖ' : isExamSubToday ? 'üìù' : '‚¨ú'}
                                                        </td>
                                                    ) : <td key={sub} className="p-3 border bg-gray-50 text-center">‚Äî</td>;
                                                })}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>

                        <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-6 mb-4">
                            <h3 className="text-xl font-bold text-blue-900 mb-4">üìÖ Tuition Weekly Schedule</h3>
                            {list.filter(s=>schedules[s.id]).length > 0 ? (
                                list.filter(s=>schedules[s.id]).map(st => (
                                    <div key={st.id} className="bg-white rounded-lg shadow p-4 mb-4">
                                        <h4 className="font-bold mb-3">{st.name}</h4>
                                        <div className="grid grid-cols-6 gap-2">
                                            {days.map((d,i) => (
                                                <div key={d} className="border rounded p-2 bg-blue-50">
                                                    <h5 className="font-bold text-xs text-center mb-2">{d}</h5>
                                                    {(schedules[st.id]?.[i]||[]).map(sub => (
                                                        <div key={sub} className="bg-yellow-100 border border-yellow-300 rounded px-2 py-1 text-xs font-bold text-center mb-1">{sub}</div>
                                                    ))}
                                                    {!(schedules[st.id]?.[i]||[]).length && <div className="text-xs text-gray-400 text-center">Not set</div>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-8 text-gray-500">
                                    <p className="mb-2">No tuition schedules set yet</p>
                                    <p className="text-sm">Click ‚úèÔ∏è next to student name to create schedule</p>
                                </div>
                            )}
                        </div>

                        <div className="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-6 border-2 border-blue-300">
                            <h3 className="font-bold text-lg mb-3 text-blue-900">üìñ How to Use:</h3>
                            <div className="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <h4 className="font-bold mb-2 text-blue-800">Daily Tracking:</h4>
                                    <ul className="space-y-1">
                                        <li>‚úÖ Click checkbox to mark subject as taught</li>
                                        <li>üéØ Click subject heading to toggle all students</li>
                                        <li>üìù Exam days show üìù icon for exam subjects</li>
                                        <li>üéØ Students with exams show "EXAM DAY" indicator</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-bold mb-2 text-blue-800">Exam Management:</h4>
                                    <ul className="space-y-1">
                                        <li>üìö Click book icon to set exam dates</li>
                                        <li>üìÖ Exams can span 2-3 weeks</li>
                                        <li>üîî System highlights exam days automatically</li>
                                        <li>‚ú® After exams, normal timetable shows</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-bold mb-2 text-blue-800">Timetable Features:</h4>
                                    <ul className="space-y-1">
                                        <li>üè´ New format: Days in rows, periods in columns</li>
                                        <li>üìä Up to 8 periods per day supported</li>
                                        <li>üçΩÔ∏è Use BREAK/LUNCH for break periods</li>
                                        <li>‚úèÔ∏è Easy edit and update anytime</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 className="font-bold mb-2 text-blue-800">Sorting & Features:</h4>
                                    <ul className="space-y-1">
                                        <li>üìä Click headers to sort by name/grade</li>
                                        <li>üè´ ABACUS students at bottom (Jancy)</li>
                                        {user === 'jancy' && <li>‚öôÔ∏è Add/edit/remove students</li>}
                                        <li>üíæ Auto-save to Firebase</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
