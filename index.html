<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuition Centre Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Firebase Configuration - REPLACE WITH YOUR CONFIG
         const firebaseConfig = {
  apiKey: "AIzaSyCIi6V8Q7zlKLd7BmjyylD87fLBaKkO65U",
  authDomain: "tuitiontracker-ac584.firebaseapp.com",
  projectId: "tuitiontracker-ac584",
  storageBucket: "tuitiontracker-ac584.firebasestorage.app",
  messagingSenderId: "121462363628",
  appId: "1:121462363628:web:7c9a1e8574dc2d74381cc9"
  databaseURL: "https://tuitiontracker-ac584-default-rtdb.asia-southeast1.firebasedatabase.app/"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Constants
        const PASSWORDS = { jancy: 'J404', arya: 'Y234', jabeena: 'J123' };
        
        const INITIAL_STUDENTS = {
            jancy: [
                { id: 3, name: "DEVDATH V P", grade: 6, time: "4PM-6PM", subjects: ["Malayalam", "Maths", "English", "BS", "SS", "Hindi"] },
                { id: 5, name: "DHIJIN", grade: 4, time: "4-6", subjects: ["Malayalam", "Maths", "English", "EVS"] }
            ],
            arya: [
                { id: 4, name: "DEVNAND", grade: 3, time: "4PM-6PM", subjects: ["Malayalam", "Maths", "English", "EVS"] },
                { id: 6, name: "ABHIDEV", grade: 4, time: "5-6.30", subjects: ["Malayalam", "Maths", "English", "EVS", "IT", "GK", "Hindi"] }
            ],
            jabeena: [
                { id: 7, name: "AADHIDEV", grade: 8, time: "5-6.30", subjects: ["Malayalam", "Maths", "English", "SS", "PHYS", "CHEM", "BIO", "Hindi"] },
                { id: 8, name: "TOM JOSE", grade: 10, time: "4.30-7.30", subjects: ["Malayalam", "Maths", "English", "SS1", "PHYS", "CHEM", "BIO", "Hindi", "SS2"] }
            ]
        };

        // State
        let state = {
            currentUser: null,
            selectedFaculty: null,
            selectedDate: new Date().toISOString().split('T')[0],
            weeklyData: {},
            studentsData: INITIAL_STUDENTS,
            showReport: false,
            showManagement: false,
            showTimetables: false,
            reportStartDate: (() => {
                const date = new Date();
                date.setDate(date.getDate() - 7);
                return date.toISOString().split('T')[0];
            })(),
            reportEndDate: new Date().toISOString().split('T')[0],
            editingStudent: null,
            newStudent: { name: '', grade: '', time: '', subjects: '', faculty: 'jancy' },
            timetableImages: {},
            examSchedules: {},
            hideExamSchedule: {}
        };

        // Lucide Icons as SVG
        const icons = {
            checkSquare: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
            square: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>',
            calendar: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            bookOpen: '<svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>',
            edit: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
            trash: '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>',
            upload: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>',
            image: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>',
            x: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
        };

        // Firebase operations
        async function initializeFirebase() {
            try {
                // Load students
                const studentsDoc = await db.collection('tuition').doc('students').get();
                if (studentsDoc.exists) {
                    state.studentsData = studentsDoc.data();
                } else {
                    await db.collection('tuition').doc('students').set(INITIAL_STUDENTS);
                }

                // Load weekly data
                const weeklyDoc = await db.collection('tuition').doc('weeklyData').get();
                if (weeklyDoc.exists) {
                    state.weeklyData = weeklyDoc.data();
                }

                // Load timetable images
                const timetableDoc = await db.collection('tuition').doc('timetables').get();
                if (timetableDoc.exists) {
                    state.timetableImages = timetableDoc.data() || {};
                }

                // Load exam schedules
                const examDoc = await db.collection('tuition').doc('examSchedules').get();
                if (examDoc.exists) {
                    state.examSchedules = examDoc.data() || {};
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
        }

        async function saveStudents() {
            await db.collection('tuition').doc('students').set(state.studentsData);
        }

        async function saveWeeklyData() {
            await db.collection('tuition').doc('weeklyData').set(state.weeklyData);
        }

        async function saveTimetables() {
            await db.collection('tuition').doc('timetables').set(state.timetableImages);
        }

        async function saveExamSchedules() {
            await db.collection('tuition').doc('examSchedules').set(state.examSchedules);
        }

        async function uploadImage(file, studentId, type) {
            const storageRef = storage.ref();
            const fileName = `${type}_${studentId}_${Date.now()}.${file.name.split('.').pop()}`;
            const imageRef = storageRef.child(`timetables/${fileName}`);
            
            await imageRef.put(file);
            const url = await imageRef.getDownloadURL();
            return url;
        }

        async function deleteImage(url) {
            try {
                const imageRef = storage.refFromURL(url);
                await imageRef.delete();
            } catch (error) {
                console.error('Error deleting image:', error);
            }
        }

        // Helper functions
        function getNumericGrade(grade) {
            if (grade === 'LKG' || grade === 'UKG') return 0;
            return parseInt(grade) || 0;
        }

        function getSubjectsPerDay(grade) {
            const numGrade = getNumericGrade(grade);
            if (numGrade <= 4) return 'ALL';
            if (numGrade >= 5 && numGrade <= 7) return 3;
            if (numGrade >= 8 && numGrade <= 10) return 4;
            return 'ALL';
        }

        function getSuggestedSubjects(student, date) {
            const perDay = getSubjectsPerDay(student.grade);
            if (perDay === 'ALL') return student.subjects;
            
            const dayOfWeek = new Date(date).getDay();
            const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            const totalSubjects = student.subjects.length;
            const startIndex = (dayIndex * perDay) % totalSubjects;
            const result = [];
            
            for (let i = 0; i < perDay; i++) {
                const index = (startIndex + i) % totalSubjects;
                result.push(student.subjects[index]);
            }
            
            return result;
        }

        function calculateDailyCoverage(student, date) {
            const suggested = getSuggestedSubjects(student, date);
            const covered = suggested.filter(s => isCellChecked(student.id, s)).length;
            return Math.round((covered / suggested.length) * 100);
        }

        function getCurrentStudents() {
            if (!state.currentUser) return [];
            const students = state.studentsData[state.currentUser] || [];
            return students.sort((a, b) => getNumericGrade(a.grade) - getNumericGrade(b.grade));
        }

        function getAllSubjects() {
            const students = getCurrentStudents();
            const subjects = new Set();
            students.forEach(s => s.subjects.forEach(sub => subjects.add(sub)));
            return Array.from(subjects).sort();
        }

        function isCellChecked(studentId, subject) {
            return state.weeklyData[`${state.selectedDate}-${studentId}-${subject}`] || false;
        }

        async function toggleCell(studentId, subject) {
            const key = `${state.selectedDate}-${studentId}-${subject}`;
            state.weeklyData[key] = !state.weeklyData[key];
            await saveWeeklyData();
            render();
        }

        function getDateRange(start, end) {
            const dates = [];
            const current = new Date(start);
            const endDate = new Date(end);
            while (current <= endDate) {
                dates.push(new Date(current).toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }
            return dates;
        }

        function calculateWeeklyCoverage(student) {
            const dates = getDateRange(state.reportStartDate, state.reportEndDate);
            const covered = new Set();
            dates.forEach(date => {
                student.subjects.forEach(subject => {
                    if (state.weeklyData[`${date}-${student.id}-${subject}`]) {
                        covered.add(subject);
                    }
                });
            });
            return {
                covered: covered.size,
                total: student.subjects.length,
                percentage: Math.round((covered.size / student.subjects.length) * 100),
                missing: student.subjects.filter(s => !covered.has(s))
            };
        }

        // Image upload handlers
        async function handleTimetableUpload(studentId, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            try {
                const url = await uploadImage(file, studentId, 'timetable');
                if (!state.timetableImages[studentId]) {
                    state.timetableImages[studentId] = {};
                }
                state.timetableImages[studentId].url = url;
                await saveTimetables();
                render();
                alert('Timetable uploaded successfully!');
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading image');
            }
        }

        async function handleExamScheduleUpload(studentId, event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }

            try {
                const url = await uploadImage(file, studentId, 'exam');
                if (!state.examSchedules[studentId]) {
                    state.examSchedules[studentId] = {};
                }
                state.examSchedules[studentId].url = url;
                state.examSchedules[studentId].hidden = false;
                state.hideExamSchedule[studentId] = false;
                await saveExamSchedules();
                render();
                alert('Exam schedule uploaded successfully!');
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading image');
            }
        }

        async function removeTimetable(studentId) {
            if (!confirm('Remove this timetable?')) return;
            
            try {
                if (state.timetableImages[studentId]?.url) {
                    await deleteImage(state.timetableImages[studentId].url);
                }
                delete state.timetableImages[studentId];
                await saveTimetables();
                render();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error removing timetable');
            }
        }

        async function removeExamSchedule(studentId) {
            if (!confirm('Remove this exam schedule?')) return;
            
            try {
                if (state.examSchedules[studentId]?.url) {
                    await deleteImage(state.examSchedules[studentId].url);
                }
                delete state.examSchedules[studentId];
                delete state.hideExamSchedule[studentId];
                await saveExamSchedules();
                render();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error removing exam schedule');
            }
        }

        async function toggleExamScheduleVisibility(studentId) {
            state.hideExamSchedule[studentId] = !state.hideExamSchedule[studentId];
            if (state.examSchedules[studentId]) {
                state.examSchedules[studentId].hidden = state.hideExamSchedule[studentId];
                await saveExamSchedules();
            }
            render();
        }

        // Render functions
        function renderFacultySelection() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <div class="mx-auto text-purple-600 mb-4">${icons.bookOpen}</div>
                            <h1 class="text-3xl font-bold text-gray-800">Tuition Centre Tracker</h1>
                            <p class="text-gray-600 mt-2">Select your faculty</p>
                        </div>
                        <div class="space-y-4">
                            <button onclick="selectFaculty('jancy')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-4 rounded-lg">
                                Jancy (Head Faculty)
                            </button>
                            <button onclick="selectFaculty('arya')" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-4 rounded-lg">
                                Arya
                            </button>
                            <button onclick="selectFaculty('jabeena')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-4 rounded-lg">
                                Jabeena
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPasswordScreen() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 capitalize">${state.selectedFaculty}</h2>
                            <p class="text-gray-600 mt-2">Enter password</p>
                        </div>
                        <div class="space-y-4">
                            <input
                                type="password"
                                id="passwordInput"
                                placeholder="Password"
                                class="w-full px-4 py-3 border-2 rounded-lg focus:border-purple-500 focus:outline-none text-center"
                                onkeypress="if(event.key === 'Enter') verifyPassword()"
                            />
                            <button onclick="verifyPassword()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 rounded-lg">
                                Login
                            </button>
                            <button onclick="backToFacultySelection()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 rounded-lg">
                                Back
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderManagementView() {
            const colors = {
                jancy: 'bg-blue-600',
                arya: 'bg-green-600',
                jabeena: 'bg-gray-600'
            };

            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="${colors[state.currentUser]} text-white p-4">
                        <div class="max-w-7xl mx-auto flex justify-between">
                            <h1 class="text-xl font-bold">Student Management</h1>
                            <button onclick="state.showManagement = false; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                Back
                            </button>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h2 class="text-xl font-bold mb-4">${state.editingStudent ? 'Edit Student' : 'Add Student'}</h2>
                            <div class="grid md:grid-cols-2 gap-4">
                                <input type="text" id="studentName" placeholder="Name" class="border rounded px-4 py-2" value="${state.editingStudent ? state.editingStudent.name : state.newStudent.name}">
                                <input type="text" id="studentGrade" placeholder="Grade" class="border rounded px-4 py-2" value="${state.editingStudent ? state.editingStudent.grade : state.newStudent.grade}">
                                <input type="text" id="studentTime" placeholder="Time" class="border rounded px-4 py-2" value="${state.editingStudent ? state.editingStudent.time : state.newStudent.time}">
                                <input type="text" id="studentSubjects" placeholder="Subjects (comma separated)" class="border rounded px-4 py-2" value="${state.editingStudent ? (Array.isArray(state.editingStudent.subjects) ? state.editingStudent.subjects.join(', ') : state.editingStudent.subjects) : state.newStudent.subjects}">
                                <select id="studentFaculty" class="border rounded px-4 py-2">
                                    <option value="jancy" ${(state.editingStudent?.faculty || state.newStudent.faculty) === 'jancy' ? 'selected' : ''}>Jancy</option>
                                    <option value="arya" ${(state.editingStudent?.faculty || state.newStudent.faculty) === 'arya' ? 'selected' : ''}>Arya</option>
                                    <option value="jabeena" ${(state.editingStudent?.faculty || state.newStudent.faculty) === 'jabeena' ? 'selected' : ''}>Jabeena</option>
                                </select>
                                ${state.editingStudent ? `
                                    <div class="flex gap-2">
                                        <button onclick="updateStudent()" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded">Update</button>
                                        <button onclick="state.editingStudent = null; render();" class="flex-1 bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
                                    </div>
                                ` : `
                                    <button onclick="addStudent()" class="bg-blue-600 text-white px-4 py-2 rounded">Add</button>
                                `}
                            </div>
                        </div>

                        ${Object.keys(state.studentsData).map(faculty => `
                            <div class="bg-white rounded-lg shadow p-6 mb-4">
                                <h3 class="text-lg font-bold mb-4 capitalize">${faculty} (${state.studentsData[faculty].length})</h3>
                                <table class="w-full text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="p-2 border">Name</th>
                                            <th class="p-2 border">Grade</th>
                                            <th class="p-2 border">Time</th>
                                            <th class="p-2 border">Subjects</th>
                                            <th class="p-2 border">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${state.studentsData[faculty].map(student => `
                                            <tr>
                                                <td class="p-2 border">${student.name}</td>
                                                <td class="p-2 border text-center">${student.grade}</td>
                                                <td class="p-2 border text-center">${student.time}</td>
                                                <td class="p-2 border text-xs">${student.subjects.join(', ')}</td>
                                                <td class="p-2 border text-center">
                                                    <button onclick="editStudent('${faculty}', ${student.id})" class="text-blue-600 mr-2">
                                                        ${icons.edit}
                                                    </button>
                                                    <button onclick="removeStudent('${faculty}', ${student.id})" class="text-red-600">
                                                        ${icons.trash}
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderReportView() {
            const colors = {
                jancy: 'bg-blue-600',
                arya: 'bg-green-600',
                jabeena: 'bg-gray-600'
            };

            const reportStudents = state.currentUser === 'jancy' 
                ? [
                    ...state.studentsData.jancy.map(s => ({ ...s, faculty: 'Jancy' })),
                    ...state.studentsData.arya.map(s => ({ ...s, faculty: 'Arya' })),
                    ...state.studentsData.jabeena.map(s => ({ ...s, faculty: 'Jabeena' }))
                ]
                : state.studentsData[state.currentUser].map(s => ({ ...s, faculty: state.currentUser }));

            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="${colors[state.currentUser]} text-white p-4">
                        <div class="max-w-7xl mx-auto flex justify-between">
                            <h1 class="text-xl font-bold">Weekly Report</h1>
                            <button onclick="state.showReport = false; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                Back
                            </button>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-4">
                        <div class="bg-white rounded-lg shadow p-4 mb-4">
                            <h3 class="font-bold mb-3">Report Period</h3>
                            <div class="flex gap-4">
                                <div>
                                    <label class="block text-sm mb-1">Start</label>
                                    <input type="date" value="${state.reportStartDate}" onchange="state.reportStartDate = this.value; render();" class="border rounded px-4 py-2">
                                </div>
                                <div>
                                    <label class="block text-sm mb-1">End</label>
                                    <input type="date" value="${state.reportEndDate}" onchange="state.reportEndDate = this.value; render();" class="border rounded px-4 py-2">
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow p-6">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100">
                                        ${state.currentUser === 'jancy' ? '<th class="p-2 border">Faculty</th>' : ''}
                                        <th class="p-2 border">Student</th>
                                        <th class="p-2 border">Grade</th>
                                        <th class="p-2 border">Coverage</th>
                                        <th class="p-2 border">Missing</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reportStudents.map(student => {
                                        const coverage = calculateWeeklyCoverage(student);
                                        return `
                                            <tr>
                                                ${state.currentUser === 'jancy' ? `
                                                    <td class="p-2 border">
                                                        <span class="px-2 py-1 rounded text-xs ${
                                                            student.faculty === 'Jancy' ? 'bg-blue-100' :
                                                            student.faculty === 'Arya' ? 'bg-green-100' : 'bg-gray-100'
                                                        }">
                                                            ${student.faculty}
                                                        </span>
                                                    </td>
                                                ` : ''}
                                                <td class="p-2 border">${student.name}</td>
                                                <td class="p-2 border text-center">${student.grade}</td>
                                                <td class="p-2 border text-center">
                                                    <span class="px-3 py-1 rounded-full font-bold ${
                                                        coverage.percentage === 100 ? 'bg-green-100 text-green-800' :
                                                        coverage.percentage >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }">
                                                        ${coverage.percentage}%
                                                    </span>
                                                </td>
                                                <td class="p-2 border text-xs text-red-600">
                                                    ${coverage.missing.length > 0 ? coverage.missing.join(', ') : '‚úì Complete'}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTimetablesView() {
            const students = getCurrentStudents();
            const colors = {
                jancy: 'bg-blue-600',
                arya: 'bg-green-600',
                jabeena: 'bg-gray-600'
            };

            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="${colors[state.currentUser]} text-white p-4">
                        <div class="max-w-7xl mx-auto flex justify-between">
                            <h1 class="text-xl font-bold">Student Timetables & Exam Schedules</h1>
                            <button onclick="state.showTimetables = false; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                Back
                            </button>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto p-4 space-y-6">
                        ${students.map(student => `
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <div class="flex items-center justify-between mb-4 pb-4 border-b">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-900">${student.name}</h3>
                                        <p class="text-sm text-gray-600">Grade ${student.grade} ‚Ä¢ ${student.time}</p>
                                    </div>
                                </div>

                                <div class="grid md:grid-cols-2 gap-6">
                                    <!-- School Timetable -->
                                    <div class="border rounded-lg p-4">
                                        <h4 class="font-bold text-lg mb-3 flex items-center gap-2">
                                            ${icons.calendar}
                                            School Timetable
                                        </h4>
                                        
                                        ${state.timetableImages[student.id]?.url ? `
                                            <div class="space-y-3">
                                                <img src="${state.timetableImages[student.id].url}" 
                                                     alt="School Timetable" 
                                                     class="w-full rounded border shadow-sm cursor-pointer hover:shadow-lg transition"
                                                     onclick="window.open('${state.timetableImages[student.id].url}', '_blank')">
                                                <button onclick="removeTimetable(${student.id})" 
                                                        class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2">
                                                    ${icons.trash}
                                                    Remove Timetable
                                                </button>
                                            </div>
                                        ` : `
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                                <div class="text-gray-400 mb-3">${icons.image}</div>
                                                <p class="text-gray-600 mb-4">No school timetable uploaded</p>
                                                <label class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded cursor-pointer inline-flex items-center gap-2">
                                                    ${icons.upload}
                                                    Upload Timetable
                                                    <input type="file" 
                                                           accept="image/*" 
                                                           onchange="handleTimetableUpload(${student.id}, event)" 
                                                           class="hidden">
                                                </label>
                                            </div>
                                        `}
                                    </div>

                                    <!-- Exam Schedule -->
                                    <div class="border rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="font-bold text-lg flex items-center gap-2">
                                                ${icons.calendar}
                                                Exam Schedule
                                            </h4>
                                            ${state.examSchedules[student.id]?.url ? `
                                                <label class="flex items-center gap-2 text-sm">
                                                    <input type="checkbox" 
                                                           ${state.hideExamSchedule[student.id] ? 'checked' : ''}
                                                           onchange="toggleExamScheduleVisibility(${student.id})"
                                                           class="w-4 h-4">
                                                    Hide
                                                </label>
                                            ` : ''}
                                        </div>
                                        
                                        ${state.examSchedules[student.id]?.url ? `
                                            <div class="space-y-3 ${state.hideExamSchedule[student.id] ? 'opacity-50' : ''}">
                                                <img src="${state.examSchedules[student.id].url}" 
                                                     alt="Exam Schedule" 
                                                     class="w-full rounded border shadow-sm cursor-pointer hover:shadow-lg transition"
                                                     onclick="window.open('${state.examSchedules[student.id].url}', '_blank')">
                                                <div class="flex gap-2">
                                                    <label class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded cursor-pointer flex items-center justify-center gap-2">
                                                        ${icons.upload}
                                                        Update
                                                        <input type="file" 
                                                               accept="image/*" 
                                                               onchange="handleExamScheduleUpload(${student.id}, event)" 
                                                               class="hidden">
                                                    </label>
                                                    <button onclick="removeExamSchedule(${student.id})" 
                                                            class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2">
                                                        ${icons.trash}
                                                        Remove
                                                    </button>
                                                </div>
                                            </div>
                                        ` : `
                                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                                <div class="text-gray-400 mb-3">${icons.image}</div>
                                                <p class="text-gray-600 mb-4">No exam schedule uploaded</p>
                                                <label class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded cursor-pointer inline-flex items-center gap-2">
                                                    ${icons.upload}
                                                    Upload Exam Schedule
                                                    <input type="file" 
                                                           accept="image/*" 
                                                           onchange="handleExamScheduleUpload(${student.id}, event)" 
                                                           class="hidden">
                                                </label>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderMainDashboard() {
            const students = getCurrentStudents();
            const allSubjects = getAllSubjects();
            const colors = {
                jancy: { bg: 'bg-blue-600', light: 'bg-blue-100' },
                arya: { bg: 'bg-green-600', light: 'bg-green-100' },
                jabeena: { bg: 'bg-gray-600', light: 'bg-gray-100' }
            };
            const color = colors[state.currentUser];

            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="${color.bg} text-white p-4">
                        <div class="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 class="text-xl font-bold capitalize">${state.currentUser} Dashboard</h1>
                                <p class="text-sm opacity-90">${students.length} Students</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="state.showTimetables = true; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                    Timetables
                                </button>
                                <button onclick="state.showReport = true; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                    Report
                                </button>
                                ${state.currentUser === 'jancy' ? `
                                    <button onclick="state.showManagement = true; render();" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                        Manage
                                    </button>
                                ` : ''}
                                <button onclick="logout()" class="bg-white bg-opacity-20 px-4 py-2 rounded">
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-b p-4">
                        <div class="max-w-7xl mx-auto flex gap-3 items-center">
                            <div class="text-gray-600">${icons.calendar}</div>
                            <input type="date" 
                                   value="${state.selectedDate}" 
                                   onchange="state.selectedDate = this.value; render();" 
                                   class="border rounded px-4 py-2">
                        </div>
                    </div>

                    <div class="max-w-full mx-auto p-4 overflow-x-auto">
                        <div class="bg-white rounded-lg shadow">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="${color.light}">
                                        <th class="p-3 border">Student</th>
                                        <th class="p-3 border">Grade</th>
                                        <th class="p-3 border">Rule</th>
                                        <th class="p-3 border">Suggested Today</th>
                                        ${allSubjects.map(subject => `<th class="p-3 border">${subject}</th>`).join('')}
                                        <th class="p-3 border">Coverage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(student => {
                                        const suggestedToday = getSuggestedSubjects(student, state.selectedDate);
                                        const dailyCoverage = calculateDailyCoverage(student, state.selectedDate);
                                        const rule = getSubjectsPerDay(student.grade);

                                        return `
                                            <tr class="hover:bg-gray-50">
                                                <td class="p-3 border font-semibold">${student.name}</td>
                                                <td class="p-3 border text-center">${student.grade}</td>
                                                <td class="p-3 border text-center">
                                                    <span class="px-2 py-1 rounded text-xs font-semibold ${
                                                        rule === 'ALL' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'
                                                    }">
                                                        ${rule === 'ALL' ? 'All daily' : `${rule}/day`}
                                                    </span>
                                                </td>
                                                <td class="p-3 border">
                                                    <div class="flex flex-wrap gap-1">
                                                        ${suggestedToday.map(s => `
                                                            <span class="bg-yellow-200 text-yellow-900 px-2 py-0.5 rounded text-xs font-semibold">${s}</span>
                                                        `).join('')}
                                                    </div>
                                                </td>
                                                ${allSubjects.map(subject => {
                                                    const hasSubject = student.subjects.includes(subject);
                                                    const isChecked = isCellChecked(student.id, subject);
                                                    const isSuggested = suggestedToday.includes(subject);

                                                    if (!hasSubject) {
                                                        return `<td class="p-3 border bg-gray-50 text-center"><span class="text-gray-300">‚Äî</span></td>`;
                                                    }

                                                    return `
                                                        <td class="p-3 border cursor-pointer text-center ${
                                                            isChecked ? 'bg-green-100' : 
                                                            isSuggested ? 'bg-yellow-50 border-yellow-300 border-2' : 
                                                            'hover:bg-blue-50'
                                                        }" onclick="toggleCell(${student.id}, '${subject}')">
                                                            <div class="inline-block ${isChecked ? 'text-green-600' : isSuggested ? 'text-yellow-600' : 'text-gray-400'}">
                                                                ${isChecked ? icons.checkSquare : icons.square}
                                                            </div>
                                                        </td>
                                                    `;
                                                }).join('')}
                                                <td class="p-3 border text-center">
                                                    <span class="px-3 py-1 rounded-full font-bold ${
                                                        dailyCoverage === 100 ? 'bg-green-100 text-green-800' :
                                                        dailyCoverage >= 50 ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }">
                                                        ${dailyCoverage}%
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-6 bg-blue-50 rounded-lg p-4">
                            <h3 class="font-bold mb-2">üìñ How to Use:</h3>
                            <ul class="text-sm space-y-1">
                                <li>‚úÖ Click checkbox to mark subject as taught</li>
                                <li>‚≠ê Yellow highlighted subjects = Suggested for today based on rotation</li>
                                <li>üìä Coverage shows if all suggested subjects for today are complete</li>
                                <li>üìö Click "Timetables" to upload student school timetables and exam schedules</li>
                                ${state.currentUser === 'jancy' ? '<li>üîë Passwords - Jancy: J404, Arya: Y234, Jabeena: J123</li>' : ''}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.selectedFaculty) {
                app.innerHTML = renderFacultySelection();
            } else if (!state.currentUser) {
                app.innerHTML = renderPasswordScreen();
                setTimeout(() => document.getElementById('passwordInput')?.focus(), 100);
            } else if (state.showManagement && state.currentUser === 'jancy') {
                app.innerHTML = renderManagementView();
            } else if (state.showReport) {
                app.innerHTML = renderReportView();
            } else if (state.showTimetables) {
                app.innerHTML = renderTimetablesView();
            } else {
                app.innerHTML = renderMainDashboard();
            }
        }

        // Global functions
        window.selectFaculty = (faculty) => {
            state.selectedFaculty = faculty;
            render();
        };

        window.backToFacultySelection = () => {
            state.selectedFaculty = null;
            state.currentUser = null;
            render();
        };

        window.verifyPassword = () => {
            const input = document.getElementById('passwordInput');
            if (input.value === PASSWORDS[state.selectedFaculty]) {
                state.currentUser = state.selectedFaculty;
                render();
            } else {
                alert('Incorrect password!');
                input.value = '';
            }
        };

        window.logout = () => {
            state.currentUser = null;
            state.selectedFaculty = null;
            render();
        };

        window.toggleCell = toggleCell;
        window.handleTimetableUpload = handleTimetableUpload;
        window.handleExamScheduleUpload = handleExamScheduleUpload;
        window.removeTimetable = removeTimetable;
        window.removeExamSchedule = removeExamSchedule;
        window.toggleExamScheduleVisibility = toggleExamScheduleVisibility;

        window.addStudent = async () => {
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const time = document.getElementById('studentTime').value || '4-6';
            const subjects = document.getElementById('studentSubjects').value;
            const faculty = document.getElementById('studentFaculty').value;

            if (!name || !grade || !subjects) {
                alert('Please fill all required fields!');
                return;
            }

            const student = {
                id: Date.now(),
                name: name.toUpperCase(),
                grade: grade,
                time: time,
                subjects: subjects.split(',').map(s => s.trim())
            };

            state.studentsData[faculty].push(student);
            await saveStudents();
            
            state.newStudent = { name: '', grade: '', time: '', subjects: '', faculty: 'jancy' };
            render();
            alert('Student added!');
        };

        window.editStudent = (faculty, studentId) => {
            const student = state.studentsData[faculty].find(s => s.id === studentId);
            if (student) {
                state.editingStudent = { ...student, faculty };
                render();
            }
        };

        window.updateStudent = async () => {
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;
            const time = document.getElementById('studentTime').value;
            const subjects = document.getElementById('studentSubjects').value;
            const faculty = document.getElementById('studentFaculty').value;

            if (!name || !grade) {
                alert('Please fill required fields!');
                return;
            }

            const updated = {
                ...state.editingStudent,
                name: name.toUpperCase(),
                grade: grade,
                time: time,
                subjects: subjects.split(',').map(s => s.trim()),
                faculty: faculty
            };

            // Remove from all faculties
            Object.keys(state.studentsData).forEach(f => {
                state.studentsData[f] = state.studentsData[f].filter(s => s.id !== state.editingStudent.id);
            });

            // Add to selected faculty
            if (!state.studentsData[faculty]) {
                state.studentsData[faculty] = [];
            }
            state.studentsData[faculty].push(updated);

            await saveStudents();
            state.editingStudent = null;
            render();
            alert('Student updated!');
        };

        window.removeStudent = async (faculty, studentId) => {
            if (confirm('Remove this student?')) {
                state.studentsData[faculty] = state.studentsData[faculty].filter(s => s.id !== studentId);
                await saveStudents();
                render();
            }
        };

        // Initialize app
        initializeFirebase().then(() => {
            render();
        });
    </script>
</body>
</html>
